<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Find the Snake</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: url("https://images.pexels.com/photos/31533982/pexels-photo-31533982.jpeg") no-repeat center center fixed;
  background-size: cover;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 70px;
  color: white;
  text-align: center;
}

h1 {
  font-size: 2.5em;
  margin-bottom: 10px;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
}

#score {
  background: rgba(0,0,0,0.6);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 1.2em;
  margin-bottom: 20px;
}

.game-container {
  position: relative;
  display: inline-block;
  border: 3px solid #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(0,0,0,0.6);
}

#draggableWrapper {
  display: inline-block;
  cursor: grab;
  touch-action: none;
}

#draggableWrapper.dragging {
  cursor: grabbing;
}

#gameImage {
  display: block;
  border-radius: 12px;
  max-width: 90vw;
  max-height: 70vh;
  user-select: none;
  pointer-events: all;
}

#overlay {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
}

#message {
  margin-top: 15px;
  font-size: 1.3em;
  font-weight: bold;
  text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
}

.controls {
  margin-top: 20px;
}

.zoom-controls {
  margin-top: 10px;
}

.zoom-controls button {
  background: #2196F3;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  margin: 3px;
}
.zoom-controls button:hover {
  background: #0b7dda;
}

button {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 12px 20px;
  margin: 5px;
  font-size: 1em;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #45a049; }

#backBtn { background: #ff5252; }
#backBtn:hover { background: #e04646; }

#skipBtn { background: #ff9800; }
#skipBtn:hover { background: #e68a00; }

/* Game Over */
#gameOverScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

#gameOverCard {
  background: white;
  color: black;
  padding: 30px;
  border-radius: 20px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

#gameOverCard h2 { font-size: 2em; margin-bottom: 10px; }
#gameOverCard p { font-size: 1.2em; margin-bottom: 20px; }

.gameOverBtns button {
  margin: 8px;
  padding: 12px 18px;
  border: none;
  border-radius: 10px;
  font-size: 1em;
  cursor: pointer;
}

.restartBtn { background: #4CAF50; color: white; }
.restartBtn:hover { background: #3b8a3d; }

.infoBtn { background: #2196F3; color: white; }
.infoBtn:hover { background: #0b7dda; }

/* Balloon canvas */
#balloonCanvas {
  position: fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  pointer-events:none;
  z-index:2100;
  display:none;
}

/* Email screen */
#emailScreen {
  position: fixed;
  top:0; left:0;
  width:100vw;
  height:100vh;
  background: rgba(0,0,0,0.85);
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  color:white;
  z-index:3000;
}
#emailInput {
  padding: 12px;
  font-size:1em;
  border-radius:8px;
  border:none;
  width:250px;
  margin:10px;
}
#startBtn {
  padding:12px 20px;
  font-size:1em;
  border:none;
  border-radius:8px;
  background:#4CAF50;
  color:white;
  cursor:pointer;
}
#startBtn:hover { background:#3b8a3d; }
#emailError {
  color:#ff5252;
  margin-top:10px;
  display:none;
}
</style>
</head>
<body>

<!-- Email -->
<div id="emailScreen">
  <h2>üêç Enter Your Corporate Email to Play</h2>
  <input type="email" id="emailInput" placeholder="name@usv.in">
  <button id="startBtn">Start Game</button>
  <p id="emailError">‚ùå Please enter a valid corporate email.</p>
</div>

<!-- Game -->
<div id="gameScreen" style="display:none;">
  <h1>üêç Find the Snake!</h1>
  <div id="score">Score: 0 / 10</div>

  <div class="game-container">
    <div id="draggableWrapper">
      <img id="gameImage" src="" alt="Snake Game">
      <canvas id="overlay"></canvas>
    </div>
  </div>

  <div class="zoom-controls">
    <button id="zoomInBtn">‚ûï Zoom In</button>
    <button id="zoomOutBtn">‚ûñ Zoom Out</button>
  </div>

  <div id="message"></div>
  <div class="controls">
    <button id="backBtn" style="display:none;">‚¨Ö Back</button>
    <button id="skipBtn" style="display:none;">Skip / Show Answer</button>
    <button id="nextBtn" style="display:none;">Next ‚û°</button>
  </div>

  <canvas id="balloonCanvas"></canvas>

  <div id="gameOverScreen">
    <div id="gameOverCard">
      <h2 id="finalTitle">Game Over</h2>
      <p id="finalMessage">Your Score: 0/10</p>
      <div class="gameOverBtns">
        <button class="restartBtn" onclick="restartGame()">üîÑ Play Again</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
// Elements
const img = document.getElementById("gameImage");
const wrapper = document.getElementById("draggableWrapper");
const message = document.getElementById("message");
const nextBtn = document.getElementById("nextBtn");
const backBtn = document.getElementById("backBtn");
const skipBtn = document.getElementById("skipBtn");
const scoreBox = document.getElementById("score");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");
const balloonCanvas = document.getElementById("balloonCanvas");
const bctx = balloonCanvas.getContext("2d");

// Email screen
const emailScreen = document.getElementById("emailScreen");
const gameScreen = document.getElementById("gameScreen");
const emailInput = document.getElementById("emailInput");
const startBtn = document.getElementById("startBtn");
const emailError = document.getElementById("emailError");
const ALLOWED_DOMAINS = ["@usv.in","@svgcentre.in"];

let playerEmail = "";
let startTime = null;
let dataSubmitted = false;
let currentRound = 0;
let score = 0;
let balloons = [];

// Zoom + pan
let zoom = 1;
const ZOOM_STEP = 0.1;
let offset = {x: 0, y: 0};
let dragStart = {x: 0, y: 0};
let isDragging = false;

// Snake rounds
const rounds = [
  { src:"snake2.jpg", hotspot:{type:"circle",x:695,y:337,radius:301},solved:false },
  { src:"snake6.jpg", hotspot:{type:"rect",x1:50,y1:155,x2:417,y2:232},solved:false },
  { src:"snake1.jpg", hotspot:{type:"rect",x1:506,y1:271,x2:971,y2:455},solved:false },
  { src:"snake3.jpg", hotspot:{type:"rect",x1:203,y1:24,x2:255,y2:395},solved:false },
  { src:"snake4.jpg", hotspot:{type:"rect",x1:243,y1:109,x2:294,y2:204},solved:false },
  { src:"snake5.jpg", hotspot:{type:"circle",x:261,y:171,radius:29},solved:false },
  { src:"snake7.jpeg", hotspot:{type:"circle",x:1048,y:2001,radius:214},solved:false },
  { src:"snake10.jpg", hotspot:{type:"rotatedRect",points:[{x:626,y:466},{x:637,y:509},{x:169,y:735},{x:121,y:666}]},solved:false },
  { src:"snake9.jpg", hotspot:{type:"circle",x:470,y:1147,radius:69},solved:false },
  { src:"snake8.jpg", hotspot:{type:"rect",x1:489,y1:454,x2:331,y2:377},solved:false }
];

// ---------- LOGIN ----------
startBtn.addEventListener("click",()=>{
  const email=emailInput.value.trim().toLowerCase();
  if(!ALLOWED_DOMAINS.some(d=>email.endsWith(d))){
    emailError.style.display="block"; return;
  }
  emailError.style.display="none";
  playerEmail=email;
  startTime=new Date();
  emailScreen.style.display="none";
  gameScreen.style.display="block";
  loadRound();
});

// ---------- GAME LOGIC ----------
function resizeCanvas(){
  canvas.width=img.clientWidth;
  canvas.height=img.clientHeight;
}

function drawHotspot(hotspot){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="red";
  ctx.lineWidth=3;
  const scaleX = (img.clientWidth / img.naturalWidth) * zoom;
  const scaleY = (img.clientHeight / img.naturalHeight) * zoom;

  if(hotspot.type==="circle"){
    ctx.beginPath();
    ctx.arc(hotspot.x*scaleX,hotspot.y*scaleY,hotspot.radius*Math.max(scaleX,scaleY),0,2*Math.PI);
    ctx.stroke();
  } else if(hotspot.type==="rect"){
    const x=Math.min(hotspot.x1,hotspot.x2)*scaleX;
    const y=Math.min(hotspot.y1,hotspot.y2)*scaleY;
    const w=Math.abs(hotspot.x2-hotspot.x1)*scaleX;
    const h=Math.abs(hotspot.y2-hotspot.y1)*scaleY;
    ctx.strokeRect(x,y,w,h);
  } else if(hotspot.type==="rotatedRect"){
    ctx.beginPath();
    hotspot.points.forEach((p,i)=>{
      const px=p.x*scaleX;
      const py=p.y*scaleY;
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    });
    ctx.closePath();
    ctx.stroke();
  }
}

// Point in polygon function
function pointInPolygon(px,py,points){
  let inside=false;
  for(let i=0,j=points.length-1;i<points.length;j=i++){
    const xi=points[i].x, yi=points[i].y;
    const xj=points[j].x, yj=points[j].y;
    const intersect=((yi>py)!==(yj>py))&&(px<(xj-xi)*(py-yi)/(yj-yi)+xi);
    if(intersect) inside=!inside;
  }
  return inside;
}

function loadRound(){
  img.src=rounds[currentRound].src;
  message.textContent="";
  nextBtn.style.display="none";
  skipBtn.style.display="inline-block";
  backBtn.style.display=currentRound>0?"inline-block":"none";
  ctx.clearRect(0,0,canvas.width,canvas.height);
  img.onload=()=>resizeCanvas();

  if(rounds[currentRound].solved){
    drawHotspot(rounds[currentRound].hotspot);
    message.textContent="‚úÖ Already solved!";
    message.style.color="#76ff03";
    nextBtn.style.display="inline-block";
    skipBtn.style.display="none";
  }
}

// ---------- IMAGE CLICK ----------
img.addEventListener("click",function(event){
  if(rounds[currentRound].solved) return;
  const rect=img.getBoundingClientRect();
  const x=(event.clientX-rect.left)*(img.naturalWidth/img.clientWidth);
  const y=(event.clientY-rect.top)*(img.naturalHeight/img.clientHeight);
  const hotspot=rounds[currentRound].hotspot;
  let correct=false;

  if(hotspot.type==="circle"){
    const dx=x-hotspot.x, dy=y-hotspot.y;
    correct=Math.sqrt(dx*dx+dy*dy)<=hotspot.radius;
  } else if(hotspot.type==="rect"){
    correct=x>=Math.min(hotspot.x1,hotspot.x2)&&x<=Math.max(hotspot.x1,hotspot.x2)
           &&y>=Math.min(hotspot.y1,hotspot.y2)&&y<=Math.max(hotspot.y1,hotspot.y2);
  } else if(hotspot.type==="rotatedRect"){
    correct=pointInPolygon(x,y,hotspot.points);
  }

  if(correct){
    message.textContent="‚úÖ Correct! You found the snake!";
    message.style.color="#76ff03";
    rounds[currentRound].solved=true;
    score++;
    scoreBox.textContent=`Score: ${score} / ${rounds.length}`;
    drawHotspot(hotspot);
    nextBtn.style.display="inline-block";
    skipBtn.style.display="none";
  } else {
    message.textContent="‚ùå Nope, try again!";
    message.style.color="#ff5252";
  }
});

// ---------- SKIP / NEXT / BACK ----------
skipBtn.addEventListener("click",function(){
  drawHotspot(rounds[currentRound].hotspot);
  message.textContent="‚ö†Ô∏è Skipped! Here's the answer.";
  message.style.color="#ffa726";
  rounds[currentRound].solved=true;
  nextBtn.style.display="inline-block";
  skipBtn.style.display="none";
});

nextBtn.addEventListener("click",function(){
  currentRound++;
  if(currentRound<rounds.length) loadRound();
  else endGame();
});

backBtn.addEventListener("click",function(){
  if(currentRound>0){
    if(rounds[currentRound].solved&&score>0){
      score--;
      rounds[currentRound].solved=false;
      scoreBox.textContent=`Score: ${score} / ${rounds.length}`;
    }
    currentRound--;
    loadRound();
  }
});

// ---------- GAME OVER ----------
function endGame(){
  img.style.display="none";
  canvas.style.display="none";
  nextBtn.style.display="none";
  backBtn.style.display="none";
  skipBtn.style.display="none";

  let finalMessage="";
  if(score===10) finalMessage="üêç Snake Master! Incredible eyesight!";
  else if(score>=8) finalMessage="ü¶é Great Job! You‚Äôre a Snake Spotter!";
  else if(score>=5) finalMessage="üëÄ Good Try! Keep practicing your spotting skills!";
  else finalMessage="üå± Don‚Äôt worry! Next time you‚Äôll catch them all!";

  document.getElementById("finalTitle").textContent="üéÆ Game Over!";
  document.getElementById("finalMessage").textContent=`Score: ${score}/10 - ${finalMessage}`;
  document.getElementById("gameOverScreen").style.display="flex";

  if(score===rounds.length) celebrate();

  if(!dataSubmitted){
    dataSubmitted=true;
    const endTime=new Date();
    const timeTaken=Math.floor((endTime-startTime)/1000);
    const url="https://script.google.com/macros/s/AKfycbxKfEnCgKuX7_5H4k4Wh5Nzp4Xf5-_Wy6i8w9r8tf6Ur6ZLFIoOD9sm2YbxxOvhnl0/exec";
    fetch(`${url}?email=${encodeURIComponent(playerEmail)}&score=${score}&timeTaken=${timeTaken}`)
      .then(res=>res.text()).then(console.log).catch(console.error);
  }
}

// ---------- CELEBRATION ----------
function celebrate(){
  balloonCanvas.style.display="block";
  balloonCanvas.width=window.innerWidth;
  balloonCanvas.height=window.innerHeight;
  balloons=[];
  for(let i=0;i<30;i++){
    balloons.push({
      x:Math.random()*balloonCanvas.width,
      y:balloonCanvas.height+Math.random()*500,
      r:20+Math.random()*30,
      c:`hsl(${Math.random()*360},70%,60%)`,
      s:1+Math.random()*2
    });
  }
  let balloonAnimation=true;
  function updateBalloons(){
    if(!balloonAnimation) return;
    bctx.clearRect(0,0,balloonCanvas.width,balloonCanvas.height);
    for(let b of balloons){
      b.y-=b.s;
      bctx.beginPath();
      bctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      bctx.fillStyle=b.c;
      bctx.fill();
    }
    requestAnimationFrame(updateBalloons);
  }
  updateBalloons();

  const duration=5000;
  const end=Date.now()+duration;
  if(score===rounds.length){
    (function frame(){
      confetti({particleCount:5,angle:60,spread:55,origin:{x:0}});
      confetti({particleCount:5,angle:120,spread:55,origin:{x:1}});
      if(Date.now()<end) requestAnimationFrame(frame);
    })();
  }

  setTimeout(()=>{
    balloonAnimation=false;
    balloonCanvas.style.display="none";
    bctx.clearRect(0,0,balloonCanvas.width,balloonCanvas.height);
  },5000);
}

// ---------- RESTART ----------
function restartGame(){
  score=0;
  currentRound=0;
  rounds.forEach(r=>r.solved=false);
  scoreBox.textContent=`Score: ${score} / ${rounds.length}`;
  img.style.display="block";
  canvas.style.display="block";
  document.getElementById("gameOverScreen").style.display="none";
  zoom = 1;
  offset = {x:0, y:0};
  applyZoom();
  loadRound();
}

// ---------- ZOOM & PAN ----------
function applyZoom(){
  wrapper.style.transform = `translate(${offset.x}px,${offset.y}px) scale(${zoom})`;
  drawHotspot(rounds[currentRound].hotspot);
}

// Zoom buttons
document.getElementById("zoomInBtn").addEventListener("click",()=>{
  zoom += ZOOM_STEP;
  applyZoom();
});
document.getElementById("zoomOutBtn").addEventListener("click",()=>{
  zoom = Math.max(0.5, zoom-ZOOM_STEP);
  applyZoom();
});

// Mouse wheel zoom
img.addEventListener("wheel",e=>{
  e.preventDefault();
  if(e.deltaY<0) zoom+=ZOOM_STEP;
  else zoom=Math.max(0.5, zoom-ZOOM_STEP);
  applyZoom();
});

// Drag / Pan
wrapper.addEventListener("mousedown",e=>{
  isDragging=true;
  dragStart={x:e.clientX-offset.x, y:e.clientY-offset.y};
  wrapper.classList.add("dragging");
});
window.addEventListener("mousemove",e=>{
  if(!isDragging) return;
  offset.x = e.clientX-dragStart.x;
  offset.y = e.clientY-dragStart.y;
  applyZoom();
});
window.addEventListener("mouseup",()=>{
  isDragging=false;
  wrapper.classList.remove("dragging");
});

// Touch events
wrapper.addEventListener("touchstart",e=>{
  isDragging=true;
  const t=e.touches[0];
  dragStart={x:t.clientX-offset.x, y:t.clientY-offset.y};
});
window.addEventListener("touchmove",e=>{
  if(!isDragging) return;
  const t=e.touches[0];
  offset.x = t.clientX-dragStart.x;
  offset.y = t.clientY-dragStart.y;
  applyZoom();
});
window.addEventListener("touchend",()=>{isDragging=false;});

</script>
</body>
</html>
